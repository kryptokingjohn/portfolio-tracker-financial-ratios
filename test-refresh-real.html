<!DOCTYPE html>
<html>
<head>
    <title>Refresh Button Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a1a; color: white; }
        .container { max-width: 800px; margin: 0 auto; }
        .button { 
            background: rgba(37, 99, 235, 0.3); 
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #dbeafe; 
            padding: 8px 12px; 
            border-radius: 8px; 
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .button:hover { background: rgba(37, 99, 235, 0.4); }
        .button:disabled { opacity: 0.5; cursor: not-allowed; }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .log { background: #2a2a2a; padding: 10px; border-radius: 4px; margin: 10px 0; font-family: monospace; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        .warning { color: #f59e0b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔄 Portfolio Tracker - Refresh Button Test</h1>
        
        <p>This demonstrates how the refresh data button works in the portfolio tracker:</p>
        
        <button id="refreshBtn" class="button">
            <span id="refreshIcon">🔄</span>
            <span id="refreshText">Refresh Data</span>
        </button>
        
        <p><strong>Last updated:</strong> <span id="lastUpdated">Never</span></p>
        
        <div id="logs"></div>
        
        <h2>📊 What the Refresh Button Does:</h2>
        <ul>
            <li><strong>Visual Feedback:</strong> Spinning icon, disabled state, "Refreshing..." text</li>
            <li><strong>Market Data:</strong> Fetches latest stock/ETF prices from FMP API</li>
            <li><strong>Financial Ratios:</strong> Updates PE, PB, debt-to-equity, margins, etc.</li>
            <li><strong>Portfolio Calculations:</strong> Recalculates total value, gains/losses</li>
            <li><strong>Dividend Analysis:</strong> Updates dividend yields and projections</li>
            <li><strong>Caching Benefits:</strong> Uses service worker cache for faster responses</li>
        </ul>
        
        <h2>🚀 Performance Optimizations:</h2>
        <ul>
            <li><strong>API Caching:</strong> 20min fresh cache, 1hr stale-while-revalidate</li>
            <li><strong>Database Optimization:</strong> Single query with joins instead of multiple calls</li>
            <li><strong>Background Updates:</strong> Stale data served instantly, updated in background</li>
            <li><strong>Error Handling:</strong> Graceful degradation with helpful error messages</li>
        </ul>
    </div>

    <script>
        const refreshBtn = document.getElementById('refreshBtn');
        const refreshIcon = document.getElementById('refreshIcon');
        const refreshText = document.getElementById('refreshText');
        const lastUpdated = document.getElementById('lastUpdated');
        const logs = document.getElementById('logs');
        
        let isRefreshing = false;
        
        function addLog(message, type = 'info') {
            const log = document.createElement('div');
            log.className = `log ${type}`;
            log.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            logs.insertBefore(log, logs.firstChild);
        }
        
        function setRefreshingState(refreshing) {
            isRefreshing = refreshing;
            refreshBtn.disabled = refreshing;
            
            if (refreshing) {
                refreshIcon.textContent = '⚡';
                refreshIcon.classList.add('spinner');
                refreshText.textContent = 'Refreshing...';
                addLog('🔄 Refresh started - Button disabled, showing spinner', 'info');
            } else {
                refreshIcon.textContent = '🔄';
                refreshIcon.classList.remove('spinner');
                refreshText.textContent = 'Refresh Data';
                addLog('✅ Refresh completed - Button re-enabled', 'success');
            }
        }
        
        async function simulateRefresh() {
            if (isRefreshing) return;
            
            setRefreshingState(true);
            
            try {
                addLog('📊 Phase 1: Loading portfolio data from optimized database query...', 'info');
                await new Promise(resolve => setTimeout(resolve, 300));
                
                addLog('💹 Phase 2: Updating market prices (checking API cache first)...', 'info');
                await new Promise(resolve => setTimeout(resolve, 800));
                
                addLog('📈 Phase 3: Enriching with financial ratios and company data...', 'info');
                await new Promise(resolve => setTimeout(resolve, 1200));
                
                addLog('🧮 Phase 4: Recalculating portfolio metrics and dividend analysis...', 'info');
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Update last updated time
                lastUpdated.textContent = new Date().toLocaleString();
                addLog('✅ Portfolio refresh completed successfully!', 'success');
                
                // Show cache benefits
                addLog('🚀 API Cache: Served 85% of requests from cache (avg 15ms response)', 'success');
                addLog('🗂️ Database: Single optimized query completed in 0.2s', 'success');
                
            } catch (error) {
                addLog('❌ Refresh failed: ' + error.message, 'error');
                addLog('🟡 Existing data remains intact (graceful degradation)', 'warning');
            } finally {
                setRefreshingState(false);
            }
        }
        
        refreshBtn.addEventListener('click', simulateRefresh);
        
        // Initial log
        addLog('🎯 Portfolio Tracker refresh functionality ready', 'success');
        addLog('💡 Click "Refresh Data" to see the refresh process in action', 'info');
        
        // Show current optimizations
        addLog('🚀 Optimizations active: Progressive loading, API caching, database optimization', 'success');
    </script>
</body>
</html>